<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>월면계획 v2 — Main</title>

<link href="https://fonts.googleapis.com/css2?family=Zen+Dots&family=Noto+Sans+KR:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --ink:#f4f7fb;
  --ink-muted:#b7c0cf;
  --accent:#74F8F6;
  --bg-img:url("../assets/bg.png");
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink); background:#07080b;
  font-family:"Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
  overflow:hidden;
}
.bg{
  position:fixed; inset:0; z-index:0;
  background-image:
    radial-gradient(1200px 800px at 70% 30%, rgba(0,0,0,.2), rgba(0,0,0,0) 60%),
    linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35) 40%, rgba(0,0,0,.65)),
    var(--bg-img);
  background-size:cover; background-position:center; background-repeat:no-repeat;
  filter:contrast(105%) brightness(96%);
}
.home{
  position:fixed; left:16px; top:16px; z-index:3;
  display:inline-flex; align-items:center; gap:8px; height:28px; padding:0 12px;
  font:700 11px/1 "Zen Dots",sans-serif; letter-spacing:.12em; text-decoration:none;
  color:#9adfe3; border:1px solid rgba(130,255,250,.35); background:rgba(255,255,255,.03); border-radius:6px;
}
.home .chev{ width:8px; height:8px; transform:rotate(135deg); border-top:2px solid currentColor; border-right:2px solid currentColor; }
#stage{ position:fixed; inset:0; z-index:1; display:block; }
.badge{position:fixed; right:8px; top:4px; z-index:3; font:700 10px/1 "Zen Dots",sans-serif; color:#9097a3; letter-spacing:.1em; opacity:.85}
</style>

<!-- ✅ 추가: import map (JSM 내부의 `from "three"` 해석용) -->
<script type="importmap">
{
  "imports": {
    "three": "../vendor/three/build/three.module.js",
    "three/examples/jsm/": "../vendor/three/examples/jsm/"
  }
}
</script>
</head>
<body>
<div class="bg" aria-hidden="true"></div>
<a class="home" href="../index.html"><span class="chev"></span> HOME</a>
<canvas id="stage"></canvas>
<div class="badge">GAS</div>

<script type="module">
import * as THREE from '../vendor/three/build/three.module.js';
import { GLTFLoader }     from '../vendor/three/examples/jsm/loaders/GLTFLoader.js';
import { DRACOLoader }    from '../vendor/three/examples/jsm/loaders/DRACOLoader.js';
import { MeshoptDecoder } from '../vendor/three/examples/jsm/libs/meshopt_decoder.module.js';
import { OrbitControls }  from '../vendor/three/examples/jsm/controls/OrbitControls.js';

const canvas   = document.getElementById('stage');
const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(innerWidth, innerHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.0;
renderer.shadowMap.enabled = true;

const scene  = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(50, innerWidth/innerHeight, 0.1, 2000);
camera.position.set(4, 2.5, 6);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

/* 라이트 */
scene.add(new THREE.HemisphereLight(0xffffff, 0x202030, 0.8));
const dir = new THREE.DirectionalLight(0xffffff, 1.0);
dir.position.set(5, 6, 4);
dir.castShadow = true;
dir.shadow.mapSize.set(1024,1024);
scene.add(dir);

/* 그림자 바닥(선택) */
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(200,200),
  new THREE.ShadowMaterial({ opacity:0.22 })
);
ground.rotation.x = -Math.PI/2;
ground.position.y = -0.01;
ground.receiveShadow = true;
scene.add(ground);

/* GLTF 로더 + (압축 대응) 디코더 설정 */
const loader = new GLTFLoader();
const draco  = new DRACOLoader();
draco.setDecoderPath('../vendor/three/examples/jsm/libs/draco/'); // ← 슬래시 필수
loader.setDRACOLoader(draco);
loader.setMeshoptDecoder(MeshoptDecoder);

/* 모델 URL (절대경로화 + 캐시버스터) */
const MODEL_URL = new URL('../assets/solar.glb', import.meta.url).href + `?v=${Date.now()}`;
console.log('GLB URL →', MODEL_URL);

/* 로드 */
loader.load(
  MODEL_URL,
  (gltf) => {
    const root = gltf.scene || gltf.scenes?.[0];
    if (!root) { console.error('GLB: scene 없음'); return; }

    applyUniformGray(root, 0xb8bcc2); // 회색 톤
    root.traverse(o => { if (o.isMesh) { o.castShadow = true; o.receiveShadow = true; } });
    scene.add(root);
    frameToObject(root, camera, controls);
  },
  undefined,
  (err) => { console.error('GLB 로드 실패:', err); }
);

/* 회색 재질 강제 적용 */
function applyUniformGray(root, hex){
  const mat = new THREE.MeshStandardMaterial({ color:hex, roughness:0.88, metalness:0.05 });
  root.traverse(obj => {
    if (obj.isMesh) {
      try { obj.material?.map?.dispose?.(); obj.material?.dispose?.(); } catch {}
      obj.material = mat.clone();
    }
  });
}

/* 모델에 맞춘 카메라 프레이밍 */
function frameToObject(object, camera, controls){
  const box = new THREE.Box3().setFromObject(object);
  const size = box.getSize(new THREE.Vector3());
  const center = box.getCenter(new THREE.Vector3());
  const maxDim = Math.max(size.x, size.y, size.z) || 1;
  const fitDist = maxDim / (2 * Math.tan(THREE.MathUtils.degToRad(camera.fov * 0.5)));
  const dist = fitDist * 1.3;

  const dir = new THREE.Vector3(1, 0.6, 1).normalize();
  camera.position.copy(center).add(dir.multiplyScalar(dist));
  camera.near = dist/100;
  camera.far  = dist*100;
  camera.updateProjectionMatrix();

  controls.target.copy(center);
  controls.update();
}

/* 리사이즈 */
addEventListener('resize', () => {
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

/* 루프 */
renderer.setAnimationLoop(() => {
  controls.update();
  renderer.render(scene, camera);
});
</script>

</body>
</html>
